<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imam Ali ERP | Professional Auditor v2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Public+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #2563eb; --navy: #0f172a; --bg: #f8fafc; --text: #1e293b; --dim: #64748b; --success: #059669; --danger: #dc2626; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Public Sans', sans-serif; }
        body { background: var(--bg); color: var(--text); display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background: var(--navy); color: white; padding: 40px 25px; position: fixed; height: 100vh; }
        .main { margin-left: 280px; padding: 40px; width: calc(100% - 280px); }
        .nav-btn { display: block; width: 100%; padding: 14px; border-radius: 12px; border: none; background: transparent; color: #94a3b8; text-align: left; cursor: pointer; margin-bottom: 8px; font-weight: 600; }
        .nav-btn.active { background: var(--primary); color: white; }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-bottom: 40px; }
        .stat-card { background: #fff; padding: 25px; border-radius: 20px; border: 1px solid rgba(0,0,0,0.05); }
        .stat-card span { font-size: 11px; font-weight: 800; color: var(--dim); text-transform: uppercase; }
        .stat-card h2 { font-family: 'JetBrains Mono', monospace; font-size: 22px; margin-top: 10px; }
        .content-box { background: #fff; border-radius: 24px; padding: 30px; border: 1px solid rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 25px; }
        th { text-align: left; color: var(--dim); font-size: 11px; text-transform: uppercase; padding: 15px; border-bottom: 2px solid #f1f5f9; }
        td { padding: 15px; font-size: 14px; border-bottom: 1px solid #f1f5f9; font-family: 'JetBrains Mono', monospace; }
        .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-body { background: white; padding: 40px; border-radius: 24px; width: 450px; }
        input, select { width: 100%; padding: 14px; margin-bottom: 15px; border: 2px solid #f1f5f9; border-radius: 12px; font-size: 14px; }
        
        /* PDF Styles */
        #pdf-root { display: none; background: #fff; padding: 50px; color: #000; }
        .t-container { display: grid; grid-template-columns: 1fr 1fr; border: 2.5px solid var(--primary); }
        .t-side { border-right: 2.5px solid var(--primary); }
        .t-side:last-child { border-right: none; }
        .t-head { background: var(--primary); color: white; padding: 10px; text-align: center; font-weight: 800; }
        .t-row { display: flex; justify-content: space-between; padding: 5px 10px; font-size: 10px; border-bottom: 1px dashed #eee; font-family: 'JetBrains Mono'; }
        .pdf-total-line { background: #f1f5f9; padding: 10px; font-weight: 800; display: flex; justify-content: space-between; border-top: 2px solid var(--primary); color: var(--primary); }
        .double-line { border-bottom: 6px double var(--primary); font-size: 22px; font-weight: 800; font-family: 'JetBrains Mono'; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <h2 style="color: var(--primary); margin-bottom: 40px;">IMAMU ALI ERP</h2>
        <button class="nav-btn active">Live Dashboard</button>
        <button class="nav-btn" onclick="exportPDF('monthly')">Monthly T-Account PDF</button>
        <button class="nav-btn" onclick="exportPDF('annual')">Annual Statement PDF</button>
        <button class="nav-btn" onclick="exportExcel()" style="color: #10b981;">Download Excel Backup</button>
        <div style="margin-top: 50px;">
            <input type="file" id="logoInp" style="font-size: 10px; color: #64748b;">
        </div>
    </aside>

    <main class="main">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 35px;">
            <div><h1 style="font-weight: 800;">Financial Terminal</h1><p style="color: var(--dim);">Audit-Ready System</p></div>
            <button onclick="openForm()" style="background: var(--primary); color: white; border: none; padding: 14px 28px; border-radius: 14px; font-weight: 800; cursor: pointer;">+ New Transaction</button>
        </header>

        <div class="stat-grid">
            <div class="stat-card"><span>Revenue (<span class="currYearDisplay">2026</span>)</span><h2 id="crV" style="color: var(--success);">$ 0</h2></div>
            <div class="stat-card"><span>Expenses (<span class="currYearDisplay">2026</span>)</span><h2 id="drV" style="color: var(--danger);">$ 0</h2></div>
            <div class="stat-card"><span>Budget Balance</span><h2 id="netV">$ 0</h2></div>
        </div>

        <div class="content-box">
            <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px;">
                <h3 style="flex-grow: 1; font-weight: 800;">General Ledger</h3>
                <span>Year:</span>
                <input type="number" id="manualYear" value="2026" onchange="loadData()" style="width: 100px; padding: 8px; margin:0;">
                <span>Month:</span>
                <select id="mSel" onchange="loadData()" style="width: 150px; margin:0;">
                    <option value="all">Full Year</option>
                    <option value="0">January</option><option value="1">February</option><option value="2">March</option>
                    <option value="3">April</option><option value="4">May</option><option value="5">June</option>
                    <option value="6">July</option><option value="7">August</option><option value="8">September</option>
                    <option value="9">October</option><option value="10">November</option><option value="11">December</option>
                </select>
            </div>
            <table>
                <thead><tr><th>Date</th><th>Description</th><th style="text-align:right">Credit (+)</th><th style="text-align:right">Debit (-)</th><th style="text-align:center">Action</th></tr></thead>
                <tbody id="ledgerBody"></tbody>
            </table>
        </div>
    </main>

    <div id="modal" class="modal"><div class="modal-body">
        <h2 id="mTitle" style="margin-bottom: 20px; font-weight: 800;">Add Entry</h2>
        <input type="hidden" id="editId">
        <input type="text" id="desc" placeholder="Particulars (e.g. School Fees)">
        <select id="type"><option value="Income">Revenue (Credit)</option><option value="Expense">Expense (Debit)</option></select>
        <input type="number" id="amt" placeholder="Amount (TZS)">
        <input type="date" id="date">
        <button onclick="saveEntry()" style="width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; font-weight: 800; cursor: pointer;">Post Transaction</button>
        <button onclick="closeForm()" style="width: 100%; background: transparent; color: var(--dim); border: none; margin-top: 10px; cursor: pointer;">Cancel</button>
    </div></div>

    <div id="pdf-root">
        <div style="text-align: center; border-bottom: 4px solid var(--primary); padding-bottom: 20px; margin-bottom: 30px;">
            <img id="pLogo" style="max-height: 80px; margin-bottom:10px;">
            <h1 style="color:var(--primary);">IMAMU ALI SECONDARY SCHOOL</h1>
            <div id="pTitle" style="margin-top: 15px; border: 2px solid var(--primary); padding: 5px 25px; display: inline-block; font-weight: 800; color: var(--primary); text-transform: uppercase;"></div>
        </div>
        <div id="pContent"></div>
        <div style="margin-top: 50px; text-align: right;"><p style="font-weight: 800; color: var(--primary); font-size:12px;">NET SURPLUS / DEFICIT</p><div id="pNet" class="double-line"></div></div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('IMAM_V2026_FINAL')) || [];
        let logo = localStorage.getItem('IMAM_LOGO_V2026_FINAL') || "";

        document.getElementById('logoInp').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = () => { logo = reader.result; localStorage.setItem('IMAM_LOGO_V2026_FINAL', logo); };
            reader.readAsDataURL(e.target.files[0]);
        };

        function openForm(id = null) {
            if(id) {
                const item = db.find(x => x.id === id);
                document.getElementById('editId').value = id;
                document.getElementById('desc').value = item.desc;
                document.getElementById('amt').value = item.amt;
                document.getElementById('type').value = item.type;
                document.getElementById('date').value = item.date;
                document.getElementById('mTitle').innerText = "Update Record";
            } else { resetFormFields(); document.getElementById('mTitle').innerText = "New Transaction"; }
            document.getElementById('modal').style.display = 'flex';
        }

        function resetFormFields() { 
            document.getElementById('editId').value = ""; 
            document.getElementById('desc').value = ""; 
            document.getElementById('amt').value = ""; 
            document.getElementById('date').value = ""; 
            document.getElementById('type').value = "Income";
        }

        function closeForm() { document.getElementById('modal').style.display = 'none'; }

        function saveEntry() {
            const id = document.getElementById('editId').value;
            const desc = document.getElementById('desc').value;
            const amt = document.getElementById('amt').value;
            const date = document.getElementById('date').value;
            const type = document.getElementById('type').value;

            if(!desc || !amt || !date) return alert("Jaza taarifa zote!");

            const entry = { id: id ? parseInt(id) : Date.now(), desc, type, amt, date };
            
            if(id) { const idx = db.findIndex(x => x.id === parseInt(id)); db[idx] = entry; } 
            else { db.push(entry); }
            
            localStorage.setItem('IMAM_V2026_FINAL', JSON.stringify(db));
            resetFormFields(); // Hapa tunafuta kila kitu baada ya kusave
            closeForm(); 
            loadData();
        }

        function deleteEntry(id) { if(confirm("Futa muamala huu?")) { db = db.filter(x => x.id !== id); localStorage.setItem('IMAM_V2026_FINAL', JSON.stringify(db)); loadData(); } }

        function loadData() {
            const body = document.getElementById('ledgerBody');
            const m = document.getElementById('mSel').value;
            const y = document.getElementById('manualYear').value;
            let tin = 0, tex = 0;
            body.innerHTML = '';
            document.querySelectorAll('.currYearDisplay').forEach(el => el.innerText = y);

            db.filter(t => {
                const d = new Date(t.date);
                return d.getFullYear().toString() === y && (m === 'all' || d.getMonth().toString() === m);
            }).forEach(t => {
                const a = parseFloat(t.amt);
                t.type === 'Income' ? tin += a : tex += a;
                body.innerHTML += `<tr><td>${t.date}</td><td>${t.desc.toUpperCase()}</td><td style="text-align:right; color:var(--success)">${t.type==='Income'?a.toLocaleString():'-'}</td><td style="text-align:right; color:var(--danger)">${t.type==='Expense'?a.toLocaleString():'-'}</td><td style="text-align:center"><button style="border:none; background:none; color:var(--primary); font-weight:800; cursor:pointer;" onclick="openForm(${t.id})">EDIT</button> | <button style="border:none; background:none; color:var(--danger); font-weight:800; cursor:pointer;" onclick="deleteEntry(${t.id})">DEL</button></td></tr>`;
            });
            document.getElementById('crV').innerText = "TZS " + tin.toLocaleString();
            document.getElementById('drV').innerText = "TZS " + tex.toLocaleString();
            document.getElementById('netV').innerText = "TZS " + (tin - tex).toLocaleString();
        }

        function exportExcel() {
            let csv = "Date,Description,Type,Amount\n";
            db.forEach(t => { csv += `${t.date},${t.desc},${t.type},${t.amt}\n`; });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `Imam_Ali_Data.csv`; a.click();
        }

        async function exportPDF(mode) {
            document.getElementById('pLogo').src = logo;
            const mIdx = document.getElementById('mSel').value;
            const selYear = document.getElementById('manualYear').value;
            const mNames = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];
            
            let filtered = db.filter(t => { const d = new Date(t.date); return d.getFullYear().toString() === selYear && (mIdx === 'all' || d.getMonth().toString() === mIdx); });
            
            let tin = 0, tex = 0, drRows = "", crRows = "", incList = "", expList = "";
            filtered.forEach(x => {
                const a = parseFloat(x.amt);
                const row = `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee; font-size:11px; font-family:'JetBrains Mono'"><span>${x.desc.toUpperCase()} (${x.date})</span><span>${a.toLocaleString()}</span></div>`;
                if(x.type === 'Income') {
                    tin += a; crRows += `<div class="t-row"><span>${x.date}</span><span>${x.desc.toUpperCase()}</span><span>${a.toLocaleString()}</span></div>`;
                    incList += row;
                } else {
                    tex += a; drRows += `<div class="t-row"><span>${x.date}</span><span>${x.desc.toUpperCase()}</span><span>${a.toLocaleString()}</span></div>`;
                    expList += row;
                }
            });

            if(mode === 'monthly') {
                document.getElementById('pTitle').innerText = `General Ledger: ${mNames[mIdx] || 'Full Year'} ${selYear}`;
                document.getElementById('pContent').innerHTML = `<div class="t-container">
                    <div class="t-side"><div class="t-head">DEBIT (EXPENDITURE)</div>${drRows}<div class="pdf-total-line"><span>TOTAL DEBIT</span><span>${tex.toLocaleString()}</span></div></div>
                    <div class="t-side"><div class="t-head">CREDIT (INCOME)</div>${crRows}<div class="pdf-total-line"><span>TOTAL CREDIT</span><span>${tin.toLocaleString()}</span></div></div>
                </div>`;
            } else {
                document.getElementById('pTitle').innerText = `Annual Financial Statement - ${selYear}`;
                document.getElementById('pContent').innerHTML = `
                    <div style="background:var(--primary); color:white; padding:10px; font-weight:800; margin-top:10px;">OPERATING REVENUE (INCOME)</div>${incList}
                    <div class="pdf-total-line"><span>TOTAL REVENUE</span><span>${tin.toLocaleString()}</span></div>
                    <div style="background:var(--primary); color:white; padding:10px; font-weight:800; margin-top:30px;">OPERATING EXPENDITURE (EXPENSES)</div>${expList}
                    <div class="pdf-total-line"><span>TOTAL EXPENDITURE</span><span>(${tex.toLocaleString()})</span></div>`;
            }

            document.getElementById('pNet').innerText = (tin - tex).toLocaleString() + " TZS";
            const el = document.getElementById('pdf-root'); el.style.display = 'block';
            await html2pdf().set({ margin:0.5, filename:`Imam_Ali_Report_${selYear}.pdf`, jsPDF:{format:'a4'} }).from(el).save();
            el.style.display = 'none';
        }
        window.onload = loadData;
    </script>
</body>
</html>